/* 
jQuery Mini-Map plugin copyright Sam Croft <samcroft@gmail.com>
Licensed like jQuery - http://docs.jquery.com/License
*/

(function($){
	$.fn.minimap = function() {
		var miniMap;
		var miniMapCurrentView;
		var offset;
		var mapIconY;
		
		var el = this;
		var elPosition = el.offset();
		
		function setup() {
			if(!$('#mini-map').length) {
				el.after('<div id="mini-map">');
				miniMap = $('#mini-map');
				miniMap.addClass('out-of-view');
				miniMap.append('<div id="current-view">');
			}
			
			els = el.children().children();

			els.each(function(i,t){

				var me = $(this);

				var articleCoords = me.offset();
				var mapIconHeight = me.height()/8;
				var mapIconMarginTop = parseInt(me.css('margin-top'))/8;
				var mapIconMarginBottom = parseInt(me.css('margin-bottom'))/8;
				
				if (i == 0) {
					mapIconY = (articleCoords.top/8) - mapIconMarginTop;
				} else {
					mapIconY = (articleCoords.top/8) + offset;
				}
				
				offset = mapIconMarginTop + mapIconMarginBottom;

				var line = me.children(".line");

				var mapIcon = $('<div>');
				mapIcon
					.css({'height':mapIconHeight+'px', 'margin-top':mapIconMarginTop+'px', 'margin-bottom':mapIconMarginBottom+'px', 'top':mapIconY+'px'})
					.addClass(t.tagName.toLowerCase())
					.data("target-id", me.attr("id"));

				if(me.hasClass("comment_bloc")) {
					mapIcon.addClass("comment");
				} else if(line.hasClass("added")) {
					mapIcon.addClass("added");
				} else if(line.hasClass("deleted")) {
					mapIcon.addClass("deleted");
				}
				
				mapIcon.appendTo(miniMap);
			});

			miniMap.on("click", "*", function(a, b) {

				var target = $("#" + $(this).data("target-id"));

				if(target.length > 0) {
					target[0].scrollIntoView();
				}
			});
			
			mapView();
		}
		
		function mapView() {
			var miniMapHeight = 0;
			$.each(miniMap.find('div'), function(){
				miniMapHeight += parseInt($(this).outerHeight(true));
			});
			miniMapHeight += 20;

			var elOffset = el.offset();
			miniMap.css({'height':miniMapHeight+'px'});
			miniMapCurrentView = $('#current-view');
			var miniMapCurrentViewHeight = ($(window).height()/8);
			var miniMapCurrentViewWidth = ($(window).width()/8);
			miniMapCurrentView.css({'height':miniMapCurrentViewHeight+'px'});
		}

		$(window).scroll(function(){
			var miniMapCurrentViewX = $(window).scrollLeft()/8;
			var miniMapCurrentViewY = $(window).scrollTop()/8;
			
			if ($(window).scrollTop() > elPosition.top + 10) {
				miniMapCurrentView.css({'left':miniMapCurrentViewX+'px', 'top':miniMapCurrentViewY+'px'});
				if (miniMap.hasClass('out-of-view')) {
					miniMap.removeClass('out-of-view');
				}
			} else {
				if (!miniMap.hasClass('out-of-view')) {
					miniMap.addClass('out-of-view');
				}
			}
		});
		
		setup();
	};
})(jQuery);